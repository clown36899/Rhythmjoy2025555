---
description: ì‚¬ì´íŠ¸ í†µê³„(Site Stats) ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ë° ê°±ì‹  ë¡œì§ ì„¤ëª…
---

# ì‚¬ì´íŠ¸ í†µê³„(Site Stats) ì‹œìŠ¤í…œ ì‘ë™ ì›ë¦¬

ì´ ë¬¸ì„œëŠ” `events`, `users` ë“±ì˜ ì›ì²œ ë°ì´í„°ë¥¼ ì§‘ê³„í•˜ì—¬ í”„ë¡ íŠ¸ì—”ë“œ(`SwingSceneStats.tsx` ë“±)ì— ì œê³µí•˜ëŠ” í†µê³„ ì‹œìŠ¤í…œì˜ ì•„í‚¤í…ì²˜ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤.

## 1. í•µì‹¬ ì•„í‚¤í…ì²˜ (2ë‹¨ê³„ êµ¬ì¡°)

í†µê³„ ì‹œìŠ¤í…œì€ **ì„±ëŠ¥ ìµœì í™”**ë¥¼ ìœ„í•´ 2ë‹¨ê³„ ìºì‹± êµ¬ì¡°ë¥¼ ë”°ë¦…ë‹ˆë‹¤.

### 1ë‹¨ê³„: Database Indexing (`site_stats_index`)
- **ì—­í• **: ì›ì²œ ë°ì´í„°(`events`, `users` ë“±)ì˜ **'í†µê³„ìš© ìš”ì•½ë³¸(Fact Table)'**
- **ì €ì¥ ë‹¨ìœ„**: "2ì›” 15ì¼ ë¦°ë””í•© ê°•ìŠµ 1ê°œ", "í˜„ì¬ íšŒì› ìˆ˜ 150ëª…" ë“± ê°œë³„ íŒ©íŠ¸ ë‹¨ìœ„.
- **ê°±ì‹  ì£¼ì²´**: `refresh_site_stats_index()` (PostgreSQL RPC í•¨ìˆ˜)
- **íŠ¹ì§•**: ë¬´ê±°ìš´ ì›ì²œ í…Œì´ë¸”ì„ ë§¤ë²ˆ ë’¤ì§€ëŠ” ê²ƒì„ ë°©ì§€í•¨.

### 2ë‹¨ê³„: API Caching (`metrics_cache`)
- **ì—­í• **: í”„ë¡ íŠ¸ì—”ë“œê°€ ì¦‰ì‹œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” **'ìµœì¢… JSON ì™„ì œí’ˆ(Response Cache)'**
- **ì €ì¥ ë‹¨ìœ„**: `{ summary: {...}, monthly: [...] }` í˜•íƒœì˜ ê±°ëŒ€ JSON ë©ì–´ë¦¬.
- **ê°±ì‹  ì£¼ì²´**: `get-site-stats` (Netlify Function)
- **íŠ¹ì§•**: `site_stats_index`ì¡°ì°¨ ë§¤ë²ˆ ê³„ì‚°í•˜ì§€ ì•Šê³ , ë§Œë“¤ì–´ì§„ ê²°ê³¼ë¥¼ 24ì‹œê°„ ë™ì•ˆ ì¬ì‚¬ìš©í•¨.

---

## 2. ë°ì´í„° íë¦„ (Data Flow)

### [Scenario A: ì¼ë°˜ ì‚¬ìš©ì ì ‘ì† ì‹œ] (âš¡ ì´ˆê³ ì†)
1. **Client**: `get-site-stats` API í˜¸ì¶œ
2. **Server**: `metrics_cache` í…Œì´ë¸” ì¡°íšŒ
   - **Cache Hit (24ì‹œê°„ ì´ë‚´)**: ì €ì¥ëœ JSON ë°˜í™˜ (DB ì—°ì‚° 0)
   - **Cache Miss (24ì‹œê°„ ê²½ê³¼)**: -> [Scenario B]ë¡œ ìë™ ì „í™˜

### [Scenario B: ìºì‹œ ë§Œë£Œ ë˜ëŠ” ìµœì´ˆ ì ‘ì† ì‹œ] (ğŸ”„ ìë™ ê°±ì‹ )
1. **Server**: `metrics_cache`ê°€ ì—†ê±°ë‚˜ ì˜¤ë˜ë¨(24h+)ì„ ê°ì§€.
2. **Server**: `rpc('refresh_site_stats_index')` **ìë™ í˜¸ì¶œ**.
   - DB ë‚´ë¶€ì—ì„œ `events` -> `site_stats_index`ë¡œ ìµœì‹  ë°ì´í„° ì¬ì§‘ê³„ (ì•½ 1~2ì´ˆ ì†Œìš”)
3. **Server**: ê°±ì‹ ëœ `site_stats_index`ë¥¼ ì¡°íšŒí•˜ì—¬ í†µê³„ ë¡œì§(Promo, Monthly ë“±) ìˆ˜í–‰.
4. **Server**: ê²°ê³¼ë¥¼ `metrics_cache`ì— **ì €ì¥(Upsert)**í•˜ê³  Clientì— ë°˜í™˜.

### [Scenario C: ê´€ë¦¬ì ìˆ˜ë™ ê°±ì‹ ] (ğŸ”¨ ê°•ì œ ê°±ì‹ )
1. **Admin**: 'DB í†µê³„ ê°±ì‹ ' ë²„íŠ¼ í´ë¦­
2. **Client**: `rpc('refresh_site_stats_index')` ì§ì ‘ í˜¸ì¶œí•˜ì—¬ DB ì¸ë±ìŠ¤ ê°•ì œ ê°±ì‹ .
3. **Client**: ê°±ì‹  ì™„ë£Œ í›„ `get-site-stats?refresh=true` í˜¸ì¶œ.
4. **Server**: `refresh=true` íŒŒë¼ë¯¸í„° í™•ì¸ -> ìºì‹œ ë¬´ì‹œí•˜ê³  ì¸ë±ìŠ¤ ì¡°íšŒ -> ìºì‹œ ë®ì–´ì“°ê¸° -> ìµœì‹  ë°ì´í„° ë°˜í™˜.
5. **Client**: `statsUpdated` ì´ë²¤íŠ¸ ë°œì†¡ -> ì‚¬ì´ë“œë°”(`SideDrawer`) ë“± ì „ì²´ UI ì¦‰ì‹œ ë°˜ì˜.

---

## 3. ì£¼ìš” íŒŒì¼ ë° í•¨ìˆ˜

- **Backend**: `netlify/functions/get-site-stats.ts`
  - í†µê³„ API ì—”ë“œí¬ì¸íŠ¸. ìºì‹œ ê´€ë¦¬ ë° RPC ìë™ í˜¸ì¶œ ë¡œì§ í¬í•¨.
- **Admin**: `src/pages/v2/components/SwingSceneStats.tsx`
  - í†µê³„ ì°¨íŠ¸ ì»´í¬ë„ŒíŠ¸ ë° 'DB ê°±ì‹ ' ë²„íŠ¼ í•¸ë“¤ëŸ¬.
- **Frontend**: `src/components/SideDrawer.tsx`
  - `statsUpdated` ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ í†µí•´ ì‹¤ì‹œê°„ìœ¼ë¡œ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ìˆ˜ì¹˜ ê°±ì‹ .
- **Database**:
  - Table `site_stats_index`: í†µê³„ ìš”ì•½ í…Œì´ë¸”
  - Table `metrics_cache`: API ì‘ë‹µ ìºì‹œ í…Œì´ë¸”
  - Function `refresh_site_stats_index()`: ì¸ë±ìŠ¤ ê°±ì‹ ìš© PL/pgSQL í•¨ìˆ˜

## 4. ìœ ì§€ë³´ìˆ˜ ê°€ì´ë“œ

- **í†µê³„ ë¡œì§ ìˆ˜ì • ì‹œ**: `get-site-stats.ts` ë‚´ì˜ ê³„ì‚° ë¡œì§ì„ ìˆ˜ì •í•˜ë©´, ë‹¤ìŒ ìºì‹œ ê°±ì‹  ì‹œ(ë˜ëŠ” ìˆ˜ë™ ê°±ì‹  ì‹œ) ë°˜ì˜ë¨.
- **ìƒˆë¡œìš´ ì§€í‘œ ì¶”ê°€ ì‹œ**:
  1. `refresh_site_stats_index` í•¨ìˆ˜ ìˆ˜ì • (DBì—ì„œ ë°ì´í„° ì¶”ì¶œ)
  2. `get-site-stats.ts` ìˆ˜ì • (ì¶”ì¶œëœ ë°ì´í„° ê°€ê³µ ë° ì‘ë‹µ í¬í•¨)
  3. `SwingSceneStats.tsx` ìˆ˜ì • (UI í‘œì‹œ)
